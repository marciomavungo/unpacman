#!/usr/bin/env python3

import os
import sys
import subprocess


try:
    import xattr
except ImportError:
    print("Please install xattr: pip install pyxattr")
    sys.exit(1)

def get_package_files(pkg):
    """Return all files installed by a package"""
    try:
        output = subprocess.check_output(["pacman", "-Qlq", pkg], text=True)
        files = output.strip().split("\n")
        return files
    except subprocess.CalledProcessError:
        print(f"Package '{pkg}' not found or not installed.")
        return []

def label_file(file_path, pkg):
    """Set xattr label on a single file"""
    if not os.path.isfile(file_path):
        return  # skip directories or missing files
    try:
        xattr.setxattr(file_path, b"user.ULsource", pkg.encode())
    except Exception as e:
        print(f"Failed to label {file_path}: {e}")

def label_package(pkg):
    """Label all files of a package"""
    files = get_package_files(pkg)
    if not files:
        return
    for f in files:
        label_file(f, pkg)
    print(f"Labeled {len(files)} files for package '{pkg}'.")

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: unpacman-label.py <package1> [package2 ...]")
        sys.exit(1)

    for package in sys.argv[1:]:
        label_package(package)
